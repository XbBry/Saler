name: ðŸ”„ Continuous Integration

on:
  push:
    branches: [ main, develop, 'feature/*', 'hotfix/*' ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1' # Weekly CI on Monday 2 AM

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================== CODE QUALITY ====================
  code-quality:
    name: ðŸŽ¯ Code Quality & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ” Code Quality Analysis
      run: |
        echo "## ðŸ“Š Code Quality Analysis" >> $GITHUB_STEP_SUMMARY
        echo "Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“ Lines of Code
      uses: coryan/lines-of-code-action@v0.1.0
      id: loc
      with:
        exclude-regex: "test_.*_spec\\.js|\\.min\\.js|node_modules"

    - name: ðŸ“ˆ Code Statistics
      run: |
        echo "### ðŸ“ˆ Repository Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Lines**: ${{ steps.loc.outputs.count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Files**: $(find . -type f -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.tsx" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Files**: $(find . -name "*.py" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **TypeScript/JS Files**: $(find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | wc -l)" >> $GITHUB_STEP_SUMMARY

  # ==================== FRONTEND CI ====================
  frontend-ci:
    name: ðŸŽ¨ Frontend CI (Node.js ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        node-version: ['18', '20', '21']
        os: [ubuntu-latest, windows-latest, macos-latest]
        exclude:
          # Reduce matrix size for performance
          - os: windows-latest
            node-version: '18'
          - os: macos-latest
            node-version: '18'
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: ðŸŸ¦ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: 'saler/frontend/package-lock.json'

    - name: ðŸ”§ Install dependencies
      run: |
        cd saler/frontend
        npm ci --audit
        npm cache clean --force

    - name: ðŸŽ¨ Lint & Format Check
      run: |
        cd saler/frontend
        echo "### ðŸŽ¨ Frontend Linting Results" >> $GITHUB_STEP_SUMMARY
        
        # ESLint
        echo "#### ðŸ” ESLint Check" >> $GITHUB_STEP_SUMMARY
        npm run lint --silent || {
          echo "âŒ ESLint failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… ESLint passed" >> $GITHUB_STEP_SUMMARY
        
        # Prettier format check
        echo "#### ðŸ“ Format Check" >> $GITHUB_STEP_SUMMARY
        npm run format:check --silent || {
          echo "âŒ Prettier format check failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Code formatting correct" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ” Type Check
      run: |
        cd saler/frontend
        echo "#### ðŸ” TypeScript Check" >> $GITHUB_STEP_SUMMARY
        npm run type-check || {
          echo "âŒ TypeScript check failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… TypeScript check passed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ—ï¸ Build Check
      run: |
        cd saler/frontend
        echo "#### ðŸ—ï¸ Build Analysis" >> $GITHUB_STEP_SUMMARY
        npm run build:analyze || {
          echo "âŒ Build failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Build successful" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ§ª Unit Tests
      run: |
        cd saler/frontend
        echo "#### ðŸ§ª Unit Tests" >> $GITHUB_STEP_SUMMARY
        npm run test:ci -- --coverage --watchAll=false --testTimeout=10000 || {
          echo "âŒ Unit tests failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Unit tests passed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“Š Coverage Report
      uses: codecov/codecov-action@v3
      with:
        file: saler/frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage-${{ matrix.node-version }}-${{ matrix.os }}
        fail_ci_if_error: false

    - name: ðŸ“¦ Bundle Analysis
      uses: andstor/filebrowser-action@v25
      if: matrix.node-version == '20' && matrix.os == 'ubuntu-latest'
      with:
        url: "https://filebrowser.${{ secrets.FILEBROWSER_DOMAIN }}"
        username: ${{ secrets.FILEBROWSER_USERNAME }}
        password: ${{ secrets.FILEBROWSER_PASSWORD }}
        upload-path: "/ci-reports/bundles/${{ github.run_number }}"
        source-path: "saler/frontend/.next"

  # ==================== BACKEND CI ====================
  backend-ci:
    name: âš¡ Backend CI (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        ports:
          - 9200:9200

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: ðŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: 'saler/backend/requirements.txt'

    - name: ðŸ”§ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          postgresql-client \
          redis-tools \
          curl \
          jq \
          curl \
          build-essential

    - name: ðŸ“¦ Install Python dependencies
      run: |
        cd saler/backend
        python -m pip install --upgrade pip wheel setuptools
        pip install -r requirements.txt
        pip install -r requirements-dev.txt || pip install -r requirements.txt
        echo "âœ… Python dependencies installed"

    - name: ðŸ” Linting & Code Quality
      run: |
        cd saler/backend
        echo "### ðŸ” Backend Code Quality" >> $GITHUB_STEP_SUMMARY
        
        echo "#### ðŸ” Flake8 Linting" >> $GITHUB_STEP_SUMMARY
        flake8 app/ tests/ --statistics --tee --output-file=flake8-report.txt || true
        if [ -s flake8-report.txt ]; then
          echo "âŒ Flake8 issues found" >> $GITHUB_STEP_SUMMARY
          cat flake8-report.txt >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… Flake8 passed" >> $GITHUB_STEP_SUMMARY
        fi

        echo "#### ðŸŽ¨ Black Format Check" >> $GITHUB_STEP_SUMMARY
        black --check app/ tests/ --diff || {
          echo "âŒ Black format check failed - run 'black app/ tests/' to fix" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Black format check passed" >> $GITHUB_STEP_SUMMARY

        echo "#### ðŸ“¦ Import Sort Check" >> $GITHUB_STEP_SUMMARY
        isort --check-only app/ tests/ || {
          echo "âŒ Import sort check failed - run 'isort app/ tests/' to fix" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Import sort check passed" >> $GITHUB_STEP_SUMMARY

        echo "#### ðŸ” MyPy Type Check" >> $GITHUB_STEP_SUMMARY
        mypy app/ --ignore-missing-imports || {
          echo "âš ï¸ MyPy type check completed with warnings" >> $GITHUB_STEP_SUMMARY
        }
        echo "âœ… MyPy type check completed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ—„ï¸ Database Setup
      run: |
        cd saler/backend
        echo "#### ðŸ—„ï¸ Database Migration Test" >> $GITHUB_STEP_SUMMARY
        export DATABASE_URL=postgresql://postgres:password@localhost:5432/test_db
        python -m alembic upgrade head || {
          echo "âŒ Database migration failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Database migration successful" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ§ª Unit Tests
      run: |
        cd saler/backend
        echo "#### ðŸ§ª Backend Unit Tests" >> $GITHUB_STEP_SUMMARY
        export DATABASE_URL=postgresql://postgres:password@localhost:5432/test_db
        export REDIS_URL=redis://localhost:6379/0
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=html --cov-fail-under=75 --tb=short || {
          echo "âŒ Backend unit tests failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Backend unit tests passed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ§ª Integration Tests
      run: |
        cd saler/backend
        echo "#### ðŸ”— Integration Tests" >> $GITHUB_STEP_SUMMARY
        pytest tests/integration/ -v --tb=short || {
          echo "âŒ Integration tests failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Integration tests passed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“Š Coverage Report
      uses: codecov/codecov-action@v3
      with:
        file: saler/backend/coverage.xml
        flags: backend
        name: backend-coverage-${{ matrix.python-version }}
        fail_ci_if_error: false

  # ==================== DOCKER CI ====================
  docker-ci:
    name: ðŸ³ Docker Image Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ—ï¸ Build Frontend Image
      run: |
        echo "#### ðŸ—ï¸ Frontend Docker Build" >> $GITHUB_STEP_SUMMARY
        docker build -f saler/frontend/Dockerfile -t saler-frontend:test ./saler/frontend || {
          echo "âŒ Frontend Docker build failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Frontend Docker build successful" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ—ï¸ Build Backend Image
      run: |
        echo "#### ðŸ—ï¸ Backend Docker Build" >> $GITHUB_STEP_SUMMARY
        docker build -f saler/backend/Dockerfile -t saler-backend:test ./saler/backend || {
          echo "âŒ Backend Docker build failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Backend Docker build successful" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ§ª Docker Container Tests
      run: |
        cd saler
        echo "#### ðŸ§ª Docker Compose Test Suite" >> $GITHUB_STEP_SUMMARY
        docker-compose -f docker-compose.test.yml up --abort-on-container-exit || {
          echo "âŒ Docker Compose tests failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Docker Compose tests passed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ¥ Container Health Check
      run: |
        echo "#### ðŸ¥ Container Health Checks" >> $GITHUB_STEP_SUMMARY
        # Test backend health
        docker exec saler-backend-test python -c "
import sys
sys.path.append('/app')
from app.main import app
from app.core.database import engine
print('Backend imports successful')
print('Database connection test passed')
" || {
          echo "âŒ Backend health check failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        
        # Test frontend build
        docker exec saler-frontend-test npm run type-check || {
          echo "âŒ Frontend health check failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        
        echo "âœ… Container health checks passed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“Š Docker Image Analysis
      run: |
        echo "#### ðŸ“Š Docker Image Statistics" >> $GITHUB_STEP_SUMMARY
        echo "**Frontend Image:**" >> $GITHUB_STEP_SUMMARY
        docker images saler-frontend:test --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" >> $GITHUB_STEP_SUMMARY
        
        echo "**Backend Image:**" >> $GITHUB_STEP_SUMMARY
        docker images saler-backend:test --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ·ï¸ Tag Images
      if: github.ref == 'refs/heads/main'
      run: |
        docker tag saler-frontend:test $REGISTRY/$IMAGE_NAME/frontend:ci-${{ github.sha }}
        docker tag saler-backend:test $REGISTRY/$IMAGE_NAME/backend:ci-${{ github.sha }}

  # ==================== END-TO-END TESTS ====================
  e2e-tests:
    name: ðŸŽ­ End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [frontend-ci, backend-ci, docker-ci]
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸŸ¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'saler/frontend/package-lock.json'

    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'saler/backend/requirements.txt'

    - name: ðŸ“¦ Install dependencies
      run: |
        cd saler/frontend && npm ci
        cd ../backend && pip install -r requirements.txt

    - name: ðŸ—ï¸ Start Test Environment
      run: |
        cd saler
        docker-compose -f docker-compose.test.yml up -d
        sleep 30

    - name: ðŸ” Wait for services
      run: |
        echo "Waiting for services to be ready..."
        timeout 300 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done' || {
          echo "âŒ Backend service not ready"
          exit 1
        }
        timeout 300 bash -c 'until curl -f http://localhost:3000; do sleep 2; done' || {
          echo "âŒ Frontend service not ready"
          exit 1
        }
        echo "âœ… All services are ready"

    - name: ðŸ§ª Run E2E Tests
      run: |
        cd saler/frontend
        echo "#### ðŸŽ­ End-to-End Test Results" >> $GITHUB_STEP_SUMMARY
        
        # Install Playwright for E2E tests
        npx playwright install --with-deps
        
        # Run E2E tests
        npm run test:e2e || {
          echo "âŒ E2E tests failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… E2E tests passed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“Š E2E Coverage
      run: |
        cd saler/frontend
        if [ -f "coverage/lcov.info" ]; then
          codecov --file coverage/lcov.info --flags e2e
        fi

    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        cd saler
        docker-compose -f docker-compose.test.yml down -v
        docker system prune -f

  # ==================== CI SUMMARY ====================
  ci-summary:
    name: ðŸ“Š CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, frontend-ci, backend-ci, docker-ci, e2e-tests]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate CI Summary
      run: |
        echo "## ðŸ”„ Continuous Integration Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Quality**: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend CI**: ${{ needs.frontend-ci.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend CI**: ${{ needs.backend-ci.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker CI**: ${{ needs.docker-ci.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **E2E Tests**: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.code-quality.result }}" == "success" && 
              "${{ needs.frontend-ci.result }}" == "success" && 
              "${{ needs.backend-ci.result }}" == "success" && 
              "${{ needs.docker-ci.result }}" == "success" && 
              "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "### ðŸŽ‰ All CI checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Ready for deployment**" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Some CI checks failed" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Please fix the issues before proceeding**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ¿ **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Commit**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ‘¤ **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY