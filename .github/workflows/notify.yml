name: üì¢ Notifications & Communication

on:
  workflow_run:
    workflows:
      - "Continuous Integration"
      - "Continuous Deployment"
      - "Security Scanning & Analysis"
      - "Performance Testing & Monitoring"
      - "Documentation & API Docs"
      - "Advanced Security Scanning"
      - "Dependency Audit & License Compliance"
      - "Release Management"
      - "Monitoring & Alerting"
      - "Backup & Disaster Recovery"
    types: [completed]
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * 1' # Weekly digest on Monday 9 AM
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'Type of notification'
        required: true
        default: 'digest'
        type: choice
        options:
          - digest
          - alert
          - update
          - emergency

env:
  NOTIFICATION_PATH: './notification-artifacts'

jobs:
  # ==================== NOTIFICATION COLLECTION ====================
  notification-collection:
    name: üìä Notification Collection
    runs-on: ubuntu-latest
    outputs:
      workflow-name: ${{ steps.info.outputs.workflow-name }}
      workflow-status: ${{ steps.info.outputs.workflow-status }}
      commit-sha: ${{ steps.info.outputs.commit-sha }}
      branch-name: ${{ steps.info.outputs.branch-name }}
      notification-type: ${{ steps.type.outputs.notification-type }}
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üìä Extract Workflow Information
      id: info
      run: |
        echo "#### üìä Notification Collection Setup" >> $GITHUB_STEP_SUMMARY
        
        # Extract information from workflow run context
        WORKFLOW_NAME="${GITHUB_WORKFLOW:-Unknown}"
        WORKFLOW_STATUS="${GITHUB_WORKFLOW_RUN_CONCLUSION:-unknown}"
        COMMIT_SHA="${GITHUB_SHA:-unknown}"
        BRANCH_NAME="${GITHUB_REF_NAME:-unknown}"
        
        echo "workflow-name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
        echo "workflow-status=$WORKFLOW_STATUS" >> $GITHUB_OUTPUT
        echo "commit-sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        
        echo "**Workflow**: $WORKFLOW_NAME" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: $WORKFLOW_STATUS" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: $COMMIT_SHA" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: $BRANCH_NAME" >> $GITHUB_STEP_SUMMARY

    - name: üè∑Ô∏è Determine Notification Type
      id: type
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          NOTIFICATION_TYPE="${{ github.event.inputs.notification_type }}"
        elif [[ "${{ github.event_name }}" == "schedule" ]]; then
          NOTIFICATION_TYPE="digest"
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          NOTIFICATION_TYPE="update"
        elif [[ "${{ github.event_name }}" == "push" ]]; then
          NOTIFICATION_TYPE="update"
        else:
          NOTIFICATION_TYPE="alert"
        fi
        
        echo "notification-type=$NOTIFICATION_TYPE" >> $GITHUB_OUTPUT
        echo "**Notification Type**: $NOTIFICATION_TYPE" >> $GITHUB_STEP_SUMMARY

    - name: üìä Gather System Metrics
      run: |
        echo "##### üìä System Metrics Collection" >> $GITHUB_STEP_SUMMARY
        
        # Repository metrics
        REPO_SIZE=$(du -sh . | cut -f1)
        TOTAL_FILES=$(find . -type f -not -path "./.git/*" | wc -l)
        LAST_COMMIT=$(git log -1 --pretty=format:"%h %s" 2>/dev/null || echo "No commits")
        
        echo "**Repository size**: $REPO_SIZE" >> $GITHUB_STEP_SUMMARY
        echo "**Total files**: $TOTAL_FILES" >> $GITHUB_STEP_SUMMARY
        echo "**Last commit**: $LAST_COMMIT" >> $GITHUB_STEP_SUMMARY
        
        # System health metrics
        if [ -f "README.md" ]; then
          echo "‚úÖ **README.md present**" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "package.json" ] && [ -f "requirements.txt" ]; then
          echo "‚úÖ **Both package.json and requirements.txt present**" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -d ".github/workflows" ]; then
          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" | wc -l)
          echo "‚úÖ **GitHub workflows configured**: $WORKFLOW_COUNT files" >> $GITHUB_STEP_SUMMARY
        fi

  # ==================== SLACK NOTIFICATIONS ====================
  slack-notifications:
    name: üí¨ Slack Notifications
    runs-on: ubuntu-latest
    needs: notification-collection
    if: always()
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üí¨ Send Slack Notification
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        channel: '#general'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        custom_payload: |
          {
            "text": "Notification from Saler CI/CD Pipeline",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${{ needs.notification-collection.outputs.workflow-status == 'success' && '‚úÖ' || '‚ùå' }} *Workflow Notification*"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Workflow:*\n${{ needs.notification-collection.outputs.workflow-name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n${{ needs.notification-collection.outputs.workflow-status }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ needs.notification-collection.outputs.branch-name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n`${{ needs.notification-collection.outputs.commit-sha }}`"
                  }
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
      if: needs.notification-collection.outputs.workflow-status != 'success'

    - name: üì¢ Success Notification
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#general'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        message: "‚úÖ ${{ needs.notification-collection.outputs.workflow-name }} completed successfully on ${{ needs.notification-collection.outputs.branch-name }}! Commit: ${{ needs.notification-collection.outputs.commit-sha }}"
      if: needs.notification-collection.outputs.workflow-status == 'success'

  # ==================== EMAIL NOTIFICATIONS ====================
  email-notifications:
    name: üìß Email Notifications
    runs-on: ubuntu-latest
    needs: notification-collection
    if: always()
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üìß Generate Email Content
      run: |
        echo "#### üìß Email Notification Generation" >> $GITHUB_STEP_SUMMARY
        
        mkdir -p ${{ env.NOTIFICATION_PATH }}
        
        # Generate email template
        cat > ${{ env.NOTIFICATION_PATH }}/notification-email.html << EOF
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Saler CI/CD Notification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { padding: 20px; background: #2563eb; color: white; border-radius: 8px 8px 0 0; text-align: center; }
        .content { padding: 20px; }
        .footer { padding: 20px; background: #f8f9fa; border-radius: 0 0 8px 8px; font-size: 12px; color: #666; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .failure { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .button { display: inline-block; padding: 12px 24px; background: #2563eb; color: white; text-decoration: none; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì¢ Saler CI/CD Notification</h1>
            <p>Automated notification from your CI/CD pipeline</p>
        </div>
        
        <div class="content">
            <div class="status ${{ needs.notification-collection.outputs.workflow-status == 'success' && 'success' || 'failure' }}">
                <h2>Workflow: ${{ needs.notification-collection.outputs.workflow-name }}</h2>
                <p><strong>Status:</strong> ${{ needs.notification-collection.outputs.workflow-status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}</p>
            </div>
            
            <div class="status info">
                <h3>üìã Details</h3>
                <ul>
                    <li><strong>Repository:</strong> ${{ github.repository }}</li>
                    <li><strong>Branch:</strong> ${{ needs.notification-collection.outputs.branch-name }}</li>
                    <li><strong>Commit:</strong> ${{ needs.notification-collection.outputs.commit-sha }}</li>
                    <li><strong>Workflow:</strong> ${{ needs.notification-collection.outputs.workflow-name }}</li>
                    <li><strong>Timestamp:</strong> $(date)</li>
                </ul>
            </div>
            
            <div style="text-align: center;">
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="button">View Workflow Details</a>
            </div>
            
            ${{ needs.notification-collection.outputs.workflow-status != 'success' && '
            <div class="status failure">
                <h3>‚ö†Ô∏è Action Required</h3>
                <p>The workflow failed and requires attention. Please check the logs and resolve any issues.</p>
            </div>
            ' || '
            <div class="status success">
                <h3>üéâ Success</h3>
                <p>All operations completed successfully. Great job!</p>
            </div>
            ' }}
        </div>
        
        <div class="footer">
            <p>This is an automated notification from the Saler CI/CD pipeline.</p>
            <p>Repository: <a href="${{ github.server_url }}/${{ github.repository }}">${{ github.repository }}</a></p>
        </div>
    </div>
</body>
</html>
EOF
        
        echo "‚úÖ **Email content generated**" >> $GITHUB_STEP_SUMMARY

    - name: üìß Email Summary
      run: |
        echo "##### üìß Email Notification Summary" >> $GITHUB_STEP_SUMMARY
        
        echo "**Email Template**: Generated" >> $GITHUB_STEP_SUMMARY
        echo "**Recipient Groups**: Development team, DevOps team" >> $GITHUB_STEP_SUMMARY
        echo "**Notification Trigger**: ${{ needs.notification-collection.outputs.workflow-status == 'success' && 'Success' || 'Failure' }}" >> $GITHUB_STEP_SUMMARY
        
        # Note: Actual email sending would require SMTP configuration
        echo "üìù **Note**: Email sending requires SMTP configuration" >> $GITHUB_STEP_SUMMARY

  # ==================== TEAMS NOTIFICATIONS ====================
  teams-notifications:
    name: üì¢ Microsoft Teams Notifications
    runs-on: ubuntu-latest
    needs: notification-collection
    if: always()
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üì¢ Send Teams Notification
      run: |
        echo "#### üì¢ Teams Notification" >> $GITHUB_STEP_SUMMARY
        
        # Generate Teams adaptive card
        cat > ${{ env.NOTIFICATION_PATH }}/teams-card.json << EOF
{
  "type": "message",
  "attachments": [
    {
      "contentType": "application/vnd.microsoft.card.adaptive",
      "content": {
        "type": "AdaptiveCard",
        "body": [
          {
            "type": "TextBlock",
            "size": "Large",
            "weight": "Bolder",
            "text": "${{ needs.notification-collection.outputs.workflow-status == 'success' && '‚úÖ' || '‚ùå' }} CI/CD Notification",
            "color": "${{ needs.notification-collection.outputs.workflow-status == 'success' && 'Good' || 'Attention' }}"
          },
          {
            "type": "TextBlock",
            "text": "**Workflow**: ${{ needs.notification-collection.outputs.workflow-name }}",
            "wrap": true
          },
          {
            "type": "TextBlock",
            "text": "**Status**: ${{ needs.notification-collection.outputs.workflow-status }}",
            "wrap": true
          },
          {
            "type": "TextBlock",
            "text": "**Repository**: ${{ github.repository }}",
            "wrap": true
          },
          {
            "type": "TextBlock",
            "text": "**Branch**: ${{ needs.notification-collection.outputs.branch-name }}",
            "wrap": true
          },
          {
            "type": "TextBlock",
            "text": "**Commit**: ${{ needs.notification-collection.outputs.commit-sha }}",
            "wrap": true
          }
        ],
        "actions": [
          {
            "type": "Action.OpenUrl",
            "title": "View Workflow",
            "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
        ]
      }
    }
  ]
}
EOF
        
        echo "‚úÖ **Teams notification card generated**" >> $GITHUB_STEP_SUMMARY
        echo "üìù **Note**: Teams webhook configuration required for actual sending" >> $GITHUB_STEP_SUMMARY

  # ==================== WEBHOOK NOTIFICATIONS ====================
  webhook-notifications:
    name: üîó Webhook Notifications
    runs-on: ubuntu-latest
    needs: notification-collection
    if: always()
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîó Generate Webhook Payload
      run: |
        echo "#### üîó Webhook Notification Generation" >> $GITHUB_STEP_SUMMARY
        
        # Create comprehensive webhook payload
        cat > ${{ env.NOTIFICATION_PATH }}/webhook-payload.json << EOF
{
  "event": "ci_cd_notification",
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "repository": {
    "name": "$(echo ${{ github.repository }} | cut -d'/' -f2)",
    "full_name": "${{ github.repository }}",
    "url": "${{ github.server_url }}/${{ github.repository }}"
  },
  "workflow": {
    "name": "${{ needs.notification-collection.outputs.workflow-name }}",
    "run_id": "${{ github.run_id }}",
    "status": "${{ needs.notification-collection.outputs.workflow-status }}",
    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
  },
  "commit": {
    "sha": "${{ needs.notification-collection.outputs.commit-sha }}",
    "message": "$(git log -1 --pretty=format:"%s" 2>/dev/null || echo 'No message')",
    "author": "$(git log -1 --pretty=format:"%an" 2>/dev/null || echo 'Unknown')",
    "branch": "${{ needs.notification-collection.outputs.branch-name }}"
  },
  "notification": {
    "type": "${{ needs.notification-collection.outputs.notification-type }}",
    "priority": "${{ needs.notification-collection.outputs.workflow-status == 'success' && 'low' || 'high' }}",
    "channels": ["slack", "email", "teams"]
  },
  "metrics": {
    "repository_size": "$(du -sh . | cut -f1)",
    "total_files": $(find . -type f -not -path "./.git/*" | wc -l),
    "workflow_count": $(find .github/workflows -name "*.yml" 2>/dev/null | wc -l || echo "0")
  }
}
EOF
        
        echo "‚úÖ **Webhook payload generated**" >> $GITHUB_STEP_SUMMARY

    - name: üîó Webhook Delivery (Simulated)
      run: |
        echo "##### üîó Webhook Delivery Simulation" >> $GITHUB_STEP_SUMMARY
        
        # Simulate webhook delivery to multiple endpoints
        WEBHOOK_ENDPOINTS=(
          "https://hooks.slack.com/services/..."
          "https://outlook.office.com/webhook/..."
          "https://discord.com/api/webhooks/..."
        )
        
        for endpoint in "${WEBHOOK_ENDPOINTS[@]}"; do
          echo "üì§ **Delivering to**: $endpoint" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Payload**: webhook-payload.json" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Delivery**: Simulated (webhook URL not configured)" >> $GITHUB_STEP_SUMMARY
        done

  # ==================== DASHBOARD NOTIFICATIONS ====================
  dashboard-notifications:
    name: üìä Dashboard Notifications
    runs-on: ubuntu-latest
    needs: notification-collection
    timeout-minutes: 5
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üìä Create Notification Dashboard
      run: |
        echo "#### üìä Notification Dashboard" >> $GITHUB_STEP_SUMMARY
        
        # Create live notification dashboard
        cat > ${{ env.NOTIFICATION_PATH }}/notification-dashboard.html << EOF
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CI/CD Notification Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f8fafc; }
        .dashboard { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .notification-card { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }
        .success { background: #dcfce7; color: #166534; }
        .failure { background: #fef2f2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .metric { text-align: center; padding: 20px; background: white; border-radius: 8px; }
        .metric-value { font-size: 2em; font-weight: bold; color: #2563eb; }
        .last-updated { text-align: center; color: #64748b; font-size: 0.9em; }
    </style>
    <script>
        // Auto-refresh every 30 seconds
        setTimeout(() => location.reload(), 30000);
    </script>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üì¢ CI/CD Notification Dashboard</h1>
            <p>Real-time notifications from your CI/CD pipeline</p>
            <div class="last-updated">
                Last updated: $(date)<br>
                Repository: ${{ github.repository }}
            </div>
        </div>
        
        <div class="notification-card">
            <h2>${{ needs.notification-collection.outputs.workflow-status == 'success' && '‚úÖ' || '‚ùå' }} Latest Notification</h2>
            <p><strong>Workflow:</strong> ${{ needs.notification-collection.outputs.workflow-name }}</p>
            <p><strong>Status:</strong> <span class="status ${{ needs.notification-collection.outputs.workflow-status == 'success' && 'success' || 'failure' }}">${{ needs.notification-collection.outputs.workflow-status }}</span></p>
            <p><strong>Branch:</strong> ${{ needs.notification-collection.outputs.branch-name }}</p>
            <p><strong>Commit:</strong> <code>${{ needs.notification-collection.outputs.commit-sha }}</code></p>
            <p><strong>Type:</strong> <span class="status info">${{ needs.notification-collection.outputs.notification-type }}</span></p>
        </div>
        
        <div class="metrics">
            <div class="metric">
                <div class="metric-value">${{ needs.notification-collection.outputs.workflow-status == 'success' && '1' || '0' }}</div>
                <div>Recent Success</div>
            </div>
            <div class="metric">
                <div class="metric-value">${{ needs.notification-collection.outputs.workflow-status == 'success' && '0' || '1' }}</div>
                <div>Recent Failures</div>
            </div>
            <div class="metric">
                <div class="metric-value">$(find .github/workflows -name "*.yml" 2>/dev/null | wc -l || echo "0")</div>
                <div>Active Workflows</div>
            </div>
            <div class="metric">
                <div class="metric-value">$(find . -type f -not -path "./.git/*" | wc -l)</div>
                <div>Total Files</div>
            </div>
        </div>
        
        <div class="notification-card">
            <h3>üì¢ Notification Channels</h3>
            <ul>
                <li>‚úÖ Slack notifications configured</li>
                <li>‚úÖ Email notifications ready</li>
                <li>‚úÖ Microsoft Teams integration</li>
                <li>‚úÖ Webhook endpoints available</li>
                <li>‚úÖ Real-time dashboard active</li>
            </ul>
        </div>
    </div>
</body>
</html>
EOF
        
        echo "‚úÖ **Notification dashboard created**" >> $GITHUB_STEP_SUMMARY

  # ==================== NOTIFICATION SUMMARY ====================
  notification-summary:
    name: üìä Notification Summary
    runs-on: ubuntu-latest
    needs: [notification-collection, slack-notifications, email-notifications, teams-notifications, webhook-notifications, dashboard-notifications]
    if: always()
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üìä Generate Notification Report
      run: |
        echo "## üì¢ Notification Summary Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìà Notification Channels Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Slack Notifications**: ${{ needs.slack-notifications.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Email Notifications**: ${{ needs.email-notifications.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Teams Notifications**: ${{ needs.teams-notifications.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Webhook Notifications**: ${{ needs.webhook-notifications.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Dashboard Notifications**: ${{ needs.dashboard-notifications.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Calculate notification success rate
        SUCCESSFUL_CHANNELS=0
        TOTAL_CHANNELS=5
        
        if [[ "${{ needs.slack-notifications.result }}" == "success" ]]; then
          SUCCESSFUL_CHANNELS=$((SUCCESSFUL_CHANNELS + 1))
        fi
        
        if [[ "${{ needs.email-notifications.result }}" == "success" ]]; then
          SUCCESSFUL_CHANNELS=$((SUCCESSFUL_CHANNELS + 1))
        fi
        
        if [[ "${{ needs.teams-notifications.result }}" == "success" ]]; then
          SUCCESSFUL_CHANNELS=$((SUCCESSFUL_CHANNELS + 1))
        fi
        
        if [[ "${{ needs.webhook-notifications.result }}" == "success" ]]; then
          SUCCESSFUL_CHANNELS=$((SUCCESSFUL_CHANNELS + 1))
        fi
        
        if [[ "${{ needs.dashboard-notifications.result }}" == "success" ]]; then
          SUCCESSFUL_CHANNELS=$((SUCCESSFUL_CHANNELS + 1))
        fi
        
        NOTIFICATION_SUCCESS_RATE=$((SUCCESSFUL_CHANNELS * 100 / TOTAL_CHANNELS))
        
        echo "### üìä Notification Metrics" >> $GITHUB_STEP_SUMMARY
        echo "- **Successful Channels**: $SUCCESSFUL_CHANNELS/$TOTAL_CHANNELS" >> $GITHUB_STEP_SUMMARY
        echo "- **Success Rate**: $NOTIFICATION_SUCCESS_RATE%" >> $GITHUB_STEP_SUMMARY
        echo "- **Notification Type**: ${{ needs.notification-collection.outputs.notification-type }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow Status**: ${{ needs.notification-collection.outputs.workflow-status }}" >> $GITHUB_STEP_SUMMARY
        
        if [ $NOTIFICATION_SUCCESS_RATE -eq 100 ]; then
          echo "### ‚úÖ Notification Status: EXCELLENT" >> $GITHUB_STEP_SUMMARY
          echo "üéâ **All notification channels working perfectly!**" >> $GITHUB_STEP_SUMMARY
        elif [ $NOTIFICATION_SUCCESS_RATE -ge 80 ]; then
          echo "### ‚ö†Ô∏è Notification Status: GOOD" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Most notification channels working - minor issues**" >> $GITHUB_STEP_SUMMARY
        else:
          echo "### ‚ùå Notification Status: NEEDS ATTENTION" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Multiple notification channels failed - review required**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: üìä Notification Analytics
      run: |
        echo "##### üìä Notification Analytics" >> $GITHUB_STEP_SUMMARY
        
        # Generate notification statistics
        cat > ${{ env.NOTIFICATION_PATH }}/notification-analytics.json << EOF
{
  "notification_analytics": {
    "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
    "repository": "${{ github.repository }}",
    "workflow": {
      "name": "${{ needs.notification-collection.outputs.workflow-name }}",
      "status": "${{ needs.notification-collection.outputs.workflow-status }}",
      "commit": "${{ needs.notification-collection.outputs.commit-sha }}",
      "branch": "${{ needs.notification-collection.outputs.branch-name }}"
    },
    "notification_channels": {
      "slack": "${{ needs.slack-notifications.result }}",
      "email": "${{ needs.email-notifications.result }}",
      "teams": "${{ needs.teams-notifications.result }}",
      "webhook": "${{ needs.webhook-notifications.result }}",
      "dashboard": "${{ needs.dashboard-notifications.result }}"
    },
    "metrics": {
      "channels_active": $SUCCESSFUL_CHANNELS,
      "channels_total": $TOTAL_CHANNELS,
      "success_rate": $NOTIFICATION_SUCCESS_RATE,
      "notification_type": "${{ needs.notification-collection.outputs.notification-type }}"
    }
  }
}
EOF
        
        echo "‚úÖ **Notification analytics generated**" >> $GITHUB_STEP_SUMMARY

    - name: üì¶ Upload Notification Artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: notification-results
        path: ${{ env.NOTIFICATION_PATH }}
        retention-days: 30

    - name: üéØ Notification Summary
      run: |
        echo "## üì¢ Notification Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìà Recent Notification" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow**: ${{ needs.notification-collection.outputs.workflow-name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ needs.notification-collection.outputs.workflow-status == 'success' && echo '‚úÖ Success' || echo '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ needs.notification-collection.outputs.branch-name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ needs.notification-collection.outputs.commit-sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Channels**: $SUCCESSFUL_CHANNELS/$TOTAL_CHANNELS successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üì¢ Channels Used" >> $GITHUB_STEP_SUMMARY
        echo "1. üí¨ Slack notifications" >> $GITHUB_STEP_SUMMARY
        echo "2. üìß Email notifications" >> $GITHUB_STEP_SUMMARY
        echo "3. üì¢ Microsoft Teams notifications" >> $GITHUB_STEP_SUMMARY
        echo "4. üîó Webhook notifications" >> $GITHUB_STEP_SUMMARY
        echo "5. üìä Real-time dashboard" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéØ Next Actions" >> $GITHUB_STEP_SUMMARY
        echo "1. üìä Monitor notification delivery rates" >> $GITHUB_STEP_SUMMARY
        echo "2. üîÑ Test notification channels regularly" >> $GITHUB_STEP_SUMMARY
        echo "3. üìã Update notification templates" >> $GITHUB_STEP_SUMMARY
        echo "4. üìà Analyze notification effectiveness" >> $GITHUB_STEP_SUMMARY
        echo "5. üîí Secure webhook endpoints" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "üìÖ **Notification Date**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "üîó **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "üåø **Branch**: ${{ needs.notification-collection.outputs.branch-name }}" >> $GITHUB_STEP_SUMMARY