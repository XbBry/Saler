name: ðŸš€ Continuous Deployment

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      rollback:
        description: 'Rollback to previous version'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ==================== PRE-DEPLOYMENT CHECKS ====================
  pre-deployment:
    name: ðŸ” Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      deployment-environment: ${{ steps.environment.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
      build-tag: ${{ steps.version.outputs.build-tag }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ” Deployment Pre-checks
      id: check
      run: |
        echo "#### ðŸ” Pre-deployment Validation" >> $GITHUB_STEP_SUMMARY
        
        # Check if this is a tagged release
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "âœ… Tagged release detected" >> $GITHUB_STEP_SUMMARY
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        else
          # Check commit message for skip deploy
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          if [[ "$COMMIT_MSG" =~ \[skip-deploy\]|\[no-deploy\] ]]; then
            echo "âš ï¸ Deployment skipped via commit message" >> $GITHUB_STEP_SUMMARY
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "âœ… Standard branch deployment" >> $GITHUB_STEP_SUMMARY
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ·ï¸ Determine Environment
      id: environment
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "#### ðŸ·ï¸ Environment: Production" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          echo "#### ðŸ·ï¸ Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
          echo "#### ðŸ·ï¸ Environment: Staging" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ“¦ Version Information
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="dev-${{ github.sha }}"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build-tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION" >> $GITHUB_OUTPUT
        
        echo "#### ðŸ“¦ Version Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Tag**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  # ==================== SECURITY VALIDATION ====================
  security-validation:
    name: ðŸ”’ Security Pre-deployment
    runs-on: ubuntu-latest
    needs: pre-deployment
    if: needs.pre-deployment.outputs.should-deploy == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”’ Security Scan
      run: |
        echo "#### ðŸ”’ Security Validation" >> $GITHUB_STEP_SUMMARY
        
        # Install security tools
        pip install safety bandit semgrep
        
        echo "##### ðŸ›¡ï¸ Python Package Security Scan" >> $GITHUB_STEP_SUMMARY
        cd saler/backend
        safety check --json --output safety-report.json || {
          echo "âŒ Security vulnerabilities found in Python packages" >> $GITHUB_STEP_SUMMARY
          cat safety-report.json >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Python packages security scan passed" >> $GITHUB_STEP_SUMMARY

        echo "##### ðŸ” Code Security Analysis" >> $GITHUB_STEP_SUMMARY
        bandit -r app/ -f json -o bandit-report.json || {
          echo "âŒ Code security issues found" >> $GITHUB_STEP_SUMMARY
          cat bandit-report.json >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        echo "âœ… Code security analysis passed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“¦ Container Security Scan
      run: |
        echo "##### ðŸ³ Container Security Scan" >> $GITHUB_STEP_SUMMARY
        
        # Build and scan containers
        docker build -f saler/frontend/Dockerfile -t saler-frontend:test ./saler/frontend
        docker build -f saler/backend/Dockerfile -t saler-backend:test ./saler/backend
        
        # Scan with Trivy
        if command -v trivy >/dev/null 2>&1; then
          trivy image --format json --output frontend-security.json saler-frontend:test || true
          trivy image --format json --output backend-security.json saler-backend:test || true
          
          echo "âœ… Container security scan completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Trivy not available, skipping container scan" >> $GITHUB_STEP_SUMMARY
        fi

  # ==================== BUILD AND PUSH IMAGES ====================
  build-images:
    name: ðŸ—ï¸ Build & Push Images
    runs-on: ubuntu-latest
    needs: [pre-deployment, security-validation]
    if: needs.pre-deployment.outputs.should-deploy == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - name: ðŸ”‘ Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“¦ Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ needs.pre-deployment.outputs.version }}

    - name: ðŸ—ï¸ Build and Push Frontend Image
      uses: docker/build-push-action@v5
      with:
        context: ./saler/frontend
        file: ./saler/frontend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: ðŸ—ï¸ Build and Push Backend Image
      uses: docker/build-push-action@v5
      with:
        context: ./saler/backend
        file: ./saler/backend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: ðŸ“Š Build Summary
      run: |
        echo "#### ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Images built and pushed successfully**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Registry**: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
        echo "**Repository**: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tags**: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY

  # ==================== DEPLOY TO STAGING ====================
  deploy-staging:
    name: ðŸŽ¯ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-deployment, build-images]
    if: needs.pre-deployment.outputs.deployment-environment == 'staging' && needs.pre-deployment.outputs.should-deploy == 'true'
    environment:
      name: staging
      url: https://staging.saler.example.com
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”‘ Setup Kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: ðŸ”‘ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: ðŸ” Configure EKS
      run: |
        aws eks update-kubeconfig --name ${{ secrets.EKS_STAGING_CLUSTER }} --region ${{ secrets.AWS_REGION }}

    - name: ðŸ“Š Pre-deployment Status
      run: |
        echo "#### ðŸš€ Staging Deployment Started" >> $GITHUB_STEP_SUMMARY
        echo "**Target Environment**: Staging" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time**: $(date)" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ—„ï¸ Database Migration
      run: |
        echo "##### ðŸ—„ï¸ Running Database Migrations" >> $GITHUB_STEP_SUMMARY
        
        # Apply database migrations using a temporary job
        kubectl create job --from=cronjob/migration-job staging-migration-${{ github.run_number }} || true
        
        echo "âœ… Database migration initiated" >> $GITHUB_STEP_SUMMARY

    - name: ðŸš€ Deploy Application
      run: |
        echo "##### ðŸš€ Deploying Application" >> $GITHUB_STEP_SUMMARY
        
        # Update Kubernetes deployments with new image
        sed "s/{{VERSION}}/${{ needs.pre-deployment.outputs.version }}/g" saler/k8s/backend-deployment.yml | kubectl apply -f -
        sed "s/{{VERSION}}/${{ needs.pre-deployment.outputs.version }}/g" saler/k8s/frontend-deployment.yml | kubectl apply -f -
        
        # Wait for rollout to complete
        kubectl rollout status deployment/backend -n staging --timeout=300s
        kubectl rollout status deployment/frontend -n staging --timeout=300s
        
        echo "âœ… Application deployment completed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ¥ Health Check
      run: |
        echo "##### ðŸ¥ Running Health Checks" >> $GITHUB_STEP_SUMMARY
        
        STAGING_URL="https://staging.saler.example.com"
        
        # Wait for services to be ready
        timeout 300 bash -c "until curl -f $STAGING_URL/api/health; do sleep 5; done" || {
          echo "âŒ Backend health check failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        
        timeout 300 bash -c "until curl -f $STAGING_URL; do sleep 5; done" || {
          echo "âŒ Frontend health check failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        }
        
        echo "âœ… All health checks passed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ§ª Smoke Tests
      run: |
        echo "##### ðŸ§ª Running Smoke Tests" >> $GITHUB_STEP_SUMMARY
        
        STAGING_URL="https://staging.saler.example.com"
        
        # Basic smoke tests
        curl -f $STAGING_URL || exit 1
        curl -f $STAGING_URL/api/health || exit 1
        curl -f $STAGING_URL/api/docs || exit 1
        
        echo "âœ… Smoke tests completed successfully" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## âœ… Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: âœ… Successful" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: Staging" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**URL**: https://staging.saler.example.com" >> $GITHUB_STEP_SUMMARY
        echo "**Time**: $(date)" >> $GITHUB_STEP_SUMMARY

  # ==================== PRODUCTION DEPLOYMENT ====================
  production-approval:
    name: âœ… Production Approval
    runs-on: ubuntu-latest
    needs: [pre-deployment, build-images]
    if: needs.pre-deployment.outputs.deployment-environment == 'production' && needs.pre-deployment.outputs.should-deploy == 'true'
    environment:
      name: production
      url: https://app.saler.example.com
    
    steps:
    - name: ðŸ“‹ Manual Approval Required
      run: |
        echo "#### â³ Manual Approval Required" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**âš ï¸ This deployment requires manual approval from a release manager.**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the deployment changes" >> $GITHUB_STEP_SUMMARY
        echo "2. Test the staging environment" >> $GITHUB_STEP_SUMMARY
        echo "3. Approve this job to continue with production deployment" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment, build-images, production-approval]
    environment:
      name: production
      url: https://app.saler.example.com
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”‘ Setup Kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: ðŸ”‘ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: ðŸ” Configure EKS
      run: |
        aws eks update-kubeconfig --name ${{ secrets.EKS_PRODUCTION_CLUSTER }} --region ${{ secrets.AWS_REGION }}

    - name: ðŸ”„ Blue-Green Deployment
      run: |
        echo "#### ðŸ”„ Blue-Green Deployment Strategy" >> $GITHUB_STEP_SUMMARY
        
        # Get current active environment
        ACTIVE_ENV=$(kubectl get ingress app-ingress -n production -o jsonpath='{.metadata.annotations.app\.kubernetes\.io/active-env}' 2>/dev/null || echo "green")
        NEW_ENV=$([ "$ACTIVE_ENV" = "green" ] && echo "blue" || echo "green")
        
        echo "**Active Environment**: $ACTIVE_ENV" >> $GITHUB_STEP_SUMMARY
        echo "**Deploying to**: $NEW_ENV" >> $GITHUB_STEP_SUMMARY
        
        # Deploy to new environment
        envsubst < saler/k8s/blue-green-deployment.yml | kubectl apply -f -
        
        # Wait for new deployment to be ready
        kubectl rollout status deployment/backend-$NEW_ENV -n production --timeout=600s
        kubectl rollout status deployment/frontend-$NEW_ENV -n production --timeout=600s
        
        # Run health checks on new environment
        NEW_URL="https://$NEW_ENV.saler.example.com"
        timeout 300 bash -c "until curl -f $NEW_URL/api/health; do sleep 5; done" || {
          echo "âŒ Health check failed for new environment" >> $GITHUB_STEP_SUMMARY
          kubectl rollout undo deployment/backend-$NEW_ENV -n production
          kubectl rollout undo deployment/frontend-$NEW_ENV -n production
          exit 1
        }
        
        # Switch traffic to new environment
        kubectl patch ingress app-ingress -n production --patch '{"metadata":{"annotations":{"app.kubernetes.io/active-env":"'$NEW_ENV'"}}}'
        
        echo "âœ… Blue-green deployment successful" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ—„ï¸ Database Migration
      run: |
        echo "##### ðŸ—„ï¸ Production Database Migration" >> $GITHUB_STEP_SUMMARY
        
        # Create backup before migration
        kubectl create job --from=cronjob/backup-job pre-migration-backup-${{ github.run_number }} || true
        
        # Apply migrations with careful monitoring
        kubectl create job --from=cronjob/migration-job production-migration-${{ github.run_number }} || true
        
        echo "âœ… Production database migration initiated" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ§ª Smoke Tests
      run: |
        echo "##### ðŸ§ª Production Smoke Tests" >> $GITHUB_STEP_SUMMARY
        
        PRODUCTION_URL="https://app.saler.example.com"
        
        # Comprehensive smoke tests
        curl -f $PRODUCTION_URL || exit 1
        curl -f $PRODUCTION_URL/api/health || exit 1
        curl -f $PRODUCTION_URL/api/docs || exit 1
        
        # Test critical API endpoints
        curl -f $PRODUCTION_URL/api/auth/health || exit 1
        curl -f $PRODUCTION_URL/api/leads || exit 1
        curl -f $PRODUCTION_URL/api/analytics || exit 1
        
        echo "âœ… Production smoke tests passed" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“Š Update Monitoring
      run: |
        echo "##### ðŸ“Š Updating Monitoring Dashboards" >> $GITHUB_STEP_SUMMARY
        
        # Update Grafana dashboards with new deployment info
        kubectl create configmap deployment-info \
          --from-literal=version=${{ needs.pre-deployment.outputs.version }} \
          --from-literal=commit=${{ github.sha }} \
          --from-literal=deployed-at=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
          -n monitoring || true
        
        echo "âœ… Monitoring dashboards updated" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## âœ… Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: âœ… Successful" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**URL**: https://app.saler.example.com" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time**: $(date)" >> $GITHUB_STEP_SUMMARY

  # ==================== POST-DEPLOYMENT ====================
  post-deployment:
    name: ðŸ“Š Post-deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Deployment Report
      run: |
        echo "## ðŸ“Š Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Deployment Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Staging**: ${{ needs.deploy-staging.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Production**: ${{ needs.deploy-production.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.deploy-staging.result }}" == "success" || "${{ needs.deploy-production.result }}" == "success" ]]; then
          echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸš€ Application successfully deployed**" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "**âš ï¸ Please check the deployment logs and resolve any issues**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Monitor application performance" >> $GITHUB_STEP_SUMMARY
        echo "2. Check error logs and metrics" >> $GITHUB_STEP_SUMMARY
        echo "3. Verify all features are working correctly" >> $GITHUB_STEP_SUMMARY
        echo "4. Update team on successful deployment" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“¢ Notify Success
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        message: "ðŸŽ‰ Deployment successful! Version ${{ needs.pre-deployment.outputs.version || 'unknown' }} deployed to ${{ needs.pre-deployment.outputs.deployment-environment || 'staging' }}"

    - name: ðŸ“¢ Notify Failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        message: "âŒ Deployment failed! Version ${{ needs.pre-deployment.outputs.version || 'unknown' }} deployment to ${{ needs.pre-deployment.outputs.deployment-environment || 'staging' }} failed. Please check the logs and take appropriate action."

    - name: ðŸ”„ Create Rollback Point
      if: success()
      run: |
        # Create a rollback point record
        echo "rollback-point-${{ github.run_number }}-${{ needs.pre-deployment.outputs.version }}" >> deployment-history.log
        
        # Store rollback information
        kubectl create configmap rollback-info \
          --from-literal=version=${{ needs.pre-deployment.outputs.version }} \
          --from-literal=commit=${{ github.sha }} \
          --from-literal=deployed-at=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
          --from-literal=rollback-command="kubectl rollout undo deployment/backend -n production" \
          -n production || true