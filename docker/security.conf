# Docker Security Configuration
# =============================

# 1. Non-root user enforcement
# Always run containers as non-root user
FROM ubuntu:20.04

# Create non-root user with specific UID/GID
RUN groupadd -r appuser --gid=1001 && \
    useradd -r -g appuser --uid=1001 --home-dir=/app --shell=/sbin/nologin appuser

# 2. Security scanning
# Install security scanning tools
RUN apt-get update && apt-get install -y \
    # Security tools
    curl \
    wget \
    gnupg \
    lsb-release \
    # Vulnerability scanners
    trivy \
    # Process monitoring
    htop \
    # File integrity
    aide \
    # Cleanup
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# 3. Package management security
# Only install necessary packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Minimal packages
    ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get autoremove -y \
    && apt-get autoclean

# 4. Security configurations
# Set proper file permissions
RUN chmod 755 /usr/local/bin/* && \
    chmod 644 /etc/passwd /etc/group

# 5. Security environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PATH="/home/appuser/.local/bin:$PATH" \
    # Security settings
    SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt \
    REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt

# 6. Security hardening for application code
RUN mkdir -p /app/logs /app/tmp && \
    chown -R appuser:appuser /app

# 7. Audit and logging
# Create audit log directory
RUN mkdir -p /var/log/audit && \
    chown appuser:appuser /var/log/audit

# 8. Container security settings
# Switch to non-root user before running application
USER appuser

# 9. Security labels and metadata
LABEL security.version="1.0" \
      security.scan="enabled" \
      security.policy="strict" \
      maintainer="security@saler.com"

# 10. Security health checks
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost/health || exit 1

# 11. Security-focused runtime configuration
# Disable unnecessary capabilities
# Note: These are applied at runtime via docker-compose or kubernetes

# 12. Security monitoring
# Add security monitoring tools
RUN pip install --no-cache-dir \
    # Security monitoring
    security-scan \
    # Vulnerability checking
    safety \
    # Dependency checking
    pip-audit

# 13. File integrity monitoring
RUN echo "*.* /var/log/audit/audit.log" > /etc/rsyslog.d/50-audit.conf

# 14. Process security
# Set up process limits
RUN echo "appuser soft nofile 65536" >> /etc/security/limits.conf && \
    echo "appuser hard nofile 65536" >> /etc/security/limits.conf && \
    echo "appuser soft nproc 4096" >> /etc/security/limits.conf && \
    echo "appuser hard nproc 4096" >> /etc/security/limits.conf

# 15. Network security
# Configure network settings
RUN echo "net.ipv4.ip_forward = 0" >> /etc/sysctl.conf && \
    echo "net.ipv4.conf.all.send_redirects = 0" >> /etc/sysctl.conf && \
    echo "net.ipv4.conf.default.send_redirects = 0" >> /etc/sysctl.conf && \
    echo "net.ipv4.conf.all.accept_redirects = 0" >> /etc/sysctl.conf && \
    echo "net.ipv4.conf.default.accept_redirects = 0" >> /etc/sysctl.conf && \
    echo "net.ipv4.conf.all.accept_source_route = 0" >> /etc/sysctl.conf && \
    echo "net.ipv4.conf.default.accept_source_route = 0" >> /etc/sysctl.conf

# 16. Memory security
RUN echo "kernel.randomize_va_space = 2" >> /etc/sysctl.conf

# 17. Container security policies
# This section would be applied via Docker Compose or Kubernetes security context

# Example Docker Compose security settings:
# security_opt:
#   - no-new-privileges:true
#   - apparmor:docker-default
#   - seccomp:docker-default
# cap_drop:
#   - ALL
# cap_add:
#   - CHOWN
#   - DAC_OVERRIDE
#   - FOWNER
#   - SETGID
#   - SETUID
# read_only: true
# tmpfs:
#   - /tmp:rw,noexec,nosuid,size=100m
#   - /var/tmp:rw,noexec,nosuid,size=100m

# 18. Resource limits (Docker Compose example)
# deploy:
#   resources:
#     limits:
#       cpus: '0.50'
#       memory: 512M
#     reservations:
#       cpus: '0.25'
#       memory: 256M

# 19. Security scanning in CI/CD
# Add security scanning to build process
# This would be implemented in your CI/CD pipeline

# 20. Runtime security monitoring
# Enable runtime security monitoring
ENV ENABLE_RUNTIME_SECURITY=true \
    SECURITY_LOG_LEVEL=INFO \
    AUDIT_LOG_ENABLED=true

# Security command to run the application
CMD ["python", "-m", "security.monitor", "--daemon"]