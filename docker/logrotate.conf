# Logrotate Configuration for Saler
# ==================================

# Global settings
compress = yes
compresscmd = /bin/gzip
compressext = .gz
delaycompress = true
copytruncate = false
missingok = true
notifempty = true
sharedscripts = false
shred = false
shredcycles = 3

# Date format for rotated files
dateext = true
dateformat = -%Y%m%d-%s

# Log rotation frequency
rotate 30
daily
size 100M

# Permissions for rotated files
create 0644 root root

# Include all app logs
/var/log/saler/*.log {
    daily
    rotate 30
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
    sharedscripts
    postrotate
        # Reload application after log rotation
        /bin/kill -USR1 $(cat /var/run/saler.pid 2>/dev/null) 2>/dev/null || true
    endscript
}

# Backend application logs
/var/log/saler/backend/*.log {
    daily
    rotate 30
    size 50M
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
    postrotate
        # Notify backend service about log rotation
        /bin/kill -USR1 $(cat /var/run/saler-backend.pid 2>/dev/null) 2>/dev/null || true
    endscript
}

# Frontend/Nginx logs
/var/log/saler/nginx/*.log {
    daily
    rotate 30
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    sharedscripts
    postrotate
        # Reload Nginx after log rotation
        /bin/kill -USR1 $(cat /var/run/nginx.pid 2>/dev/null) 2>/dev/null || true
    endscript
}

# Database logs
/var/log/saler/postgres/*.log {
    daily
    rotate 30
    size 200M
    compress
    delaycompress
    missingok
    notifempty
    sharedscripts
    postrotate
        # Signal PostgreSQL to reopen log files
        /bin/kill -HUP $(head -1 /var/run/postmaster.pid 2>/dev/null) 2>/dev/null || true
    endscript
}

# Redis logs
/var/log/saler/redis/*.log {
    daily
    rotate 30
    size 50M
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        # Signal Redis to reopen log files
        /bin/kill -USR1 $(cat /var/run/redis/redis-server.pid 2>/dev/null) 2>/dev/null || true
    endscript
}

# Security logs
/var/log/saler/security/*.log {
    daily
    rotate 90
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0600 root root
    postrotate
        # Restart audit service if needed
        /bin/systemctl reload rsyslog 2>/dev/null || true
    endscript
}

# Audit logs
/var/log/saler/audit/*.log {
    daily
    rotate 365
    size 500M
    compress
    delaycompress
    missingok
    notifempty
    create 0600 root root
    shred = true
    shredcycles = 3
    postrotate
        # Reopen audit log files
        /sbin/augenrules --load 2>/dev/null || true
    endscript
}

# Application access logs
/var/log/saler/access/*.log {
    daily
    rotate 30
    size 200M
    compress
    delaycompress
    missingok
    notifempty
    sharedscripts
    postrotate
        # Notify load balancer/proxy
        /bin/kill -USR1 $(cat /var/run/nginx.pid 2>/dev/null) 2>/dev/null || true
    endscript
}

# Error logs
/var/log/saler/error/*.log {
    daily
    rotate 90
    size 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root adm
    postrotate
        # Send notification for error logs
        echo "Error log rotation completed at $(date)" | /usr/bin/mail -s "Error Log Rotation - Saler" admin@yourdomain.com 2>/dev/null || true
    endscript
}

# Slow query logs
/var/log/saler/slow-queries/*.log {
    daily
    rotate 30
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 postgres postgres
    postrotate
        # PostgreSQL slow query log rotation
        /bin/kill -USR1 $(head -1 /var/run/postmaster.pid 2>/dev/null) 2>/dev/null || true
    endscript
}

# Backup logs
/var/log/saler/backup/*.log {
    daily
    rotate 90
    size 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 backup backup
    postrotate
        # Notify backup completion
        echo "Backup log rotation completed at $(date)" | /usr/bin/mail -s "Backup Log Rotation - Saler" backup@yourdomain.com 2>/dev/null || true
    endscript
}

# Health check logs
/var/log/saler/health/*.log {
    daily
    rotate 7
    size 10M
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        # Clean up old health check logs
        find /var/log/saler/health/ -name "*.log" -mtime +7 -delete 2>/dev/null || true
    endscript
}

# Performance monitoring logs
/var/log/saler/perf/*.log {
    daily
    rotate 30
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0644 monitor monitor
    postrotate
        # Restart performance monitoring
        /bin/systemctl restart prometheus-node-exporter 2>/dev/null || true
    endscript
}

# SSL/TLS logs
/var/log/saler/ssl/*.log {
    daily
    rotate 365
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0600 root root
    postrotate
        # Check SSL certificate expiry after rotation
        /opt/saler/scripts/check-ssl-cert.sh 2>/dev/null || true
    endscript
}

# Container logs (if using Docker)
# Docker container logs are typically handled by Docker itself
# /var/lib/docker/containers/*/*.log {
#     daily
#     rotate 7
#     size 1G
#     compress
#     delaycompress
#     missingok
#     notifempty
#     copytruncate
# }

# Kubernetes logs (if using K8s)
# Kubernetes logs are typically collected by fluentd/fluent-bit
# /var/log/containers/*.log {
#     daily
#     rotate 7
#     size 1G
#     compress
#     delaycompress
#     missingok
#     notifempty
#     copytruncate
# }

# System logs
/var/log/syslog {
    daily
    rotate 30
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    sharedscripts
    postrotate
        /bin/kill -HUP $(/bin/pidof rsyslogd) 2>/dev/null || true
    endscript
}

# Cron logs
/var/log/cron {
    weekly
    rotate 4
    size 10M
    compress
    delaycompress
    missingok
    notifempty
    sharedscripts
}

# Boot logs
/var/log/boot.log {
    monthly
    rotate 12
    size 10M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root adm
}

# Mail logs
/var/log/mail.log {
    weekly
    rotate 4
    size 10M
    compress
    delaycompress
    missingok
    notifempty
    sharedscripts
    postrotate
        /bin/kill -HUP $(/bin/pidof rsyslogd) 2>/dev/null || true
    endscript
}

# Custom log configuration
/var/log/saler/custom/*.log {
    daily
    rotate 30
    size 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 saler saler
    postrotate
        # Custom post-rotation actions
        /opt/saler/scripts/post-rotate.sh 2>/dev/null || true
    endscript
}

# Include system logrotate config
include /etc/logrotate.d

# No compression for these files
# uncompress /var/log/saler/realtime/*.log