apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: saler-ingress
  namespace: saler
  annotations:
    # Ingress controller
    kubernetes.io/ingress.class: "nginx"
    
    # SSL/TLS
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    cert-manager.io/acme-challenge-type: "http01"
    
    # HTTPS redirect
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/rate-limit-burst: "200"
    
    # CORS configuration
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    nginx.ingress.kubernetes.io/cors-expose-headers: "ETag,Link,X-RateLimit-Reset,X-RateLimit-Remaining"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    
    # Proxy settings
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    
    # Connection and keep-alive
    nginx.ingress.kubernetes.io/proxy-next-upstream: "error timeout invalid_header http_500 http_502 http_503 http_504"
    nginx.ingress.kubernetes.io/proxy-next-upstream-tries: "3"
    nginx.ingress.kubernetes.io/proxy-next-upstream-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
    
    # Load balancing
    nginx.ingress.kubernetes.io/load-balance: "round_robin"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"
    
    # Security headers configuration snippet
    nginx.ingress.kubernetes.io/configuration-snippet: |
      # Security headers
      more_set_headers "X-Frame-Options: SAMEORIGIN";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "Referrer-Policy: no-referrer-when-downgrade";
      more_set_headers "X-Download-Options: noopen";
      more_set_headers "X-Permitted-Cross-Domain-Policies: none";
      more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload";
      
      # Remove server tokens
      more_set_headers "Server: " "";
      
      # Hide nginx version
      more_clear_headers "X-Powered-By";
      
      # Custom error pages
      error_page 404 /404.html;
      error_page 500 502 503 504 /50x.html;
      
      # Bot protection
      if ($http_user_agent ~* "bot|crawler|spider|slurp") {
        return 403;
      }
    
    # WebSocket support
    nginx.ingress.kubernetes.io/proxy-set-headers: |
      X-Forwarded-For: $proxy_add_x_forwarded_for
      X-Forwarded-Proto: $scheme
      X-Real-IP: $remote_addr
      X-Forwarded-Host: $host
    
    # Session affinity
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/affinity-mode: "balanced"
    nginx.ingress.kubernetes.io/session-cookie-name: "route"
    nginx.ingress.kubernetes.io/session-cookie-expires: "172800"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "172800"
    
    # Buffer settings
    nginx.ingress.kubernetes.io/proxy-buffer-size: "4k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    nginx.ingress.kubernetes.io/proxy-busy-buffers-size: "8k"
    
    # Logging
    nginx.ingress.kubernetes.io/enable-access-log: "true"
    nginx.ingress.kubernetes.io/enable-ingress-log: "true"
    nginx.ingress.kubernetes.io/log-format-escape-json: "true"
    nginx.ingress.kubernetes.io/log-format: |
      {
        "time": "$time_iso8601",
        "remote_addr": "$remote_addr",
        "remote_user": "$remote_user",
        "method": "$request_method",
        "uri": "$request_uri",
        "protocol": "$server_protocol",
        "status": $status,
        "bytes": $body_bytes_sent,
        "req_time": $request_time,
        "upstream_addr": "$upstream_addr",
        "upstream_status": "$upstream_status",
        "upstream_response_time": "$upstream_response_time",
        "http_user_agent": "$http_user_agent",
        "http_referer": "$http_referer"
      }
    
    # Health checks
    nginx.ingress.kubernetes.io/health-check: "true"
    nginx.ingress.kubernetes.io/health-check-path: "/health"
    
    # Custom metrics
    nginx.ingress.kubernetes.io/enable-metrics: "true"
    nginx.ingress.kubernetes.io/metrics-path: "/metrics"
    
    # Enable ModSecurity (if available)
    # nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    # nginx.ingress.kubernetes.io/modsecurity-snippet: |
    #   SecRuleEngine On
    #   SecRequestBodyAccess On
    #   SecRule REQUEST_HEADERS:Content-Type "^(?:application(?:/[^/]+)?/)json(?:;[^)]*)?(?:;[^)]*)?$" "南区:@jsonParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^(?:application(?:/[^/]+)?/)xml(?:;[^)]*)?(?:;[^)]*)?$" "南区:@xmlParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^(?:text|application)/xml(?:;[^)]*)?$" "南区:@xmlParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^text/xml" "南区:@xmlParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^text/html" "南区:@xmlParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^text/plain" "南区:@xmlParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^application/json" "南区:@jsonParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^application/json" "南区:@jsonParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^application/.*\+json" "南区:@jsonParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^application/.*\+xml" "南区:@xmlParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^text/.*xml" "南区:@xmlParser"
    #   SecRule REQUEST_HEADERS:Content-Type "^text/xml" "南区:@xmlParser"
    
  labels:
    app: saler
    component: ingress
spec:
  tls:
  - hosts:
    - yourdomain.com
    - www.yourdomain.com
    - api.yourdomain.com
    secretName: saler-tls
  rules:
  # Main domain - Frontend
  - host: yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: saler-frontend-service
            port:
              number: 80
  
  # www subdomain - Frontend
  - host: www.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: saler-frontend-service
            port:
              number: 80
  
  # API subdomain - Backend
  - host: api.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: saler-backend-service
            port:
              number: 8000

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: saler-ingress-staging
  namespace: saler
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-staging"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/rate-limit: "200"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
  labels:
    app: saler
    environment: staging
    component: ingress
spec:
  tls:
  - hosts:
    - staging.yourdomain.com
    - api-staging.yourdomain.com
    secretName: saler-staging-tls
  rules:
  # Staging frontend
  - host: staging.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: saler-frontend-service
            port:
              number: 80
  
  # Staging API
  - host: api-staging.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: saler-backend-service
            port:
              number: 8000

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
data:
  # Custom Nginx configuration
  use-proxy-protocol: "false"
  enable-real-ip: "true"
  real-ip-header: "X-Forwarded-For"
  real-ip-from: "0.0.0.0/0"
  use-geoip: "false"
  
  # Worker processes
  worker-processes: "auto"
  worker-shutdown-timeout: "10s"
  
  # Worker connections
  worker-connections: "16384"
  
  # Client request settings
  client-header-buffer-size: "1k"
  large-client-header-buffers: "4 8k"
  client-body-buffer-size: "16k"
  client-body-temp-path: "/tmp/client_body"
  proxy-body-temp-path: "/tmp/proxy_temp"
  proxy-connect-timeout: "60s"
  proxy-send-timeout: "60s"
  proxy-read-timeout: "60s"
  proxy-buffer-size: "4k"
  proxy-buffers-number: "4"
  proxy-busy-buffers-size: "8k"
  
  # Timeouts
  keepalive-timeout: "65s"
  client-header-timeout: "60s"
  client-body-timeout: "60s"
  send-timeout: "60s"
  
  # Gzip compression
  use-gzip: "true"
  gzip-level: "6"
  gzip-types: "text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json"
  gzip-min-length: "1000"
  gzip-proxied: "expired no-cache no-store private auth"
  
  # SSL settings
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-prefer-server-ciphers: "true"
  ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"
  ssl-session-cache: "shared:SSL:10m"
  ssl-session-timeout: "10m"
  ssl-session-tickets: "false"
  
  # HTTP/2
  use-http2: "true"
  http2-max-field-size: "16k"
  http2-max-header-size: "32k"
  
  # Logging
  log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $bytes_sent "$http_referer" "$http_user_agent" $req_time $upstream_addr $upstream_status $upstream_response_time "$http_x_forwarded_for"'
  
  # Error log level
  error-log-level: "warn"
  
  # Custom headers
  add-headers: "nginx-ingress/saler-headers"