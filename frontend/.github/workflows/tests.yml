name: Tests CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  lint-and-type-check:
    name: ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙˆÙØ­Øµ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
    runs-on: ubuntu-latest
    
    steps:
      - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v4
        
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ØªØ«Ø¨ÙŠØª dependencies
        run: npm ci
        
      - name: ØªØ´ØºÙŠÙ„ ESLint
        run: npm run lint
        
      - name: ÙØ­Øµ Ø£Ù†ÙˆØ§Ø¹ TypeScript
        run: npm run type-check
        
      - name: ÙØ­Øµ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¯
        run: npm run format:check

  unit-tests:
    name: Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
    runs-on: ubuntu-latest
    
    steps:
      - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v4
        
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ØªØ«Ø¨ÙŠØª dependencies
        run: npm ci
        
      - name: ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
        run: npm run test:ci
        env:
          NODE_ENV: test
          
      - name: Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: unit-tests-coverage
          
      - name: Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± HTML Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        uses: actions/upload-artifact@v3
        with:
          name: test-report-html
          path: coverage/report.html
          
      - name: Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØºØ·ÙŠØ©
        uses: actions/upload-artifact@v3
        with:
          name: coverage-data
          path: coverage/

  integration-tests:
    name: Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„
    runs-on: ubuntu-latest
    
    steps:
      - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v4
        
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ØªØ«Ø¨ÙŠØª dependencies
        run: npm ci
        
      - name: ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„
        run: npm run test -- --testPathPattern=integration
        env:
          NODE_ENV: test
          
      - name: Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-report
          path: coverage/integration-report.html

  e2e-tests:
    name: Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª End-to-End
    runs-on: ubuntu-latest
    
    steps:
      - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v4
        
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ØªØ«Ø¨ÙŠØª dependencies
        run: npm ci
        
      - name: ØªØ«Ø¨ÙŠØª Playwright
        run: npx playwright install --with-deps
        
      - name: Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ù…Ø­Ù„ÙŠØ§Ù‹
        run: npm run start &
        
      - name: Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù…
        run: npx wait-on http://localhost:3000
        
      - name: ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª E2E
        run: npx playwright test
        env:
          BASE_URL: http://localhost:3000
          
      - name: Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± E2E
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results
          path: |
            playwright-report/
            test-results/
            
      - name: Ø±ÙØ¹ Ù„Ù‚Ø·Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: e2e-failure-screenshots
          path: test-results/

  security-audit:
    name: ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
    runs-on: ubuntu-latest
    
    steps:
      - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v4
        
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ØªØ«Ø¨ÙŠØª dependencies
        run: npm ci
        
      - name: ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
        run: npm audit --audit-level moderate
        
      - name: ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
        run: npx audit-ci --moderate

  performance-tests:
    name: Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v4
        
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ØªØ«Ø¨ÙŠØª dependencies
        run: npm ci
        
      - name: Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: ØªØ´ØºÙŠÙ„ Lighthouse
        uses: treosh/lighthouse-ci-action@v9
        with:
          configPath: './lighthouserc.js'
          uploadArtifacts: true
          temporaryPublicStorage: true

  build-and-deploy:
    name: Ø¨Ù†Ø§Ø¡ ÙˆÙ†Ø´Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, unit-tests, integration-tests, security-audit]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v4
        
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ØªØ«Ø¨ÙŠØª dependencies
        run: npm ci
        
      - name: Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: ØªØ­Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ø­Ø²Ù…Ø©
        run: npm run build:analyze
        env:
          ANALYZE: true
          
      - name: Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            .next/
            public/
            package.json
            package-lock.json
            
      - name: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡
        run: npm run start &
        env:
          NODE_ENV: production
          
      - name: ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡
        run: npx wait-on http://localhost:3000 && curl -f http://localhost:3000

  test-coverage-report:
    name: ØªÙ‚Ø±ÙŠØ± ØªØºØ·ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()
    
    steps:
      - name: Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
        uses: actions/checkout@v4
        
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ØªØ«Ø¨ÙŠØª dependencies
        run: npm ci
        
      - name: ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¹ Ø§Ù„ØªØºØ·ÙŠØ©
        run: npm run test:ci
        
      - name: Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„ØªØºØ·ÙŠØ©
        run: |
          npx jest --coverage --coverageReporters=html,lcov,text-summary
          
      - name: Ù†Ø´Ø± ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage/lcov-report
          destination_dir: coverage-report
          
      - name: Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Pull Request
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const path = './coverage/coverage-summary.json';
            
            if (fs.existsSync(path)) {
              const coverage = JSON.parse(fs.readFileSync(path, 'utf8'));
              const total = coverage.total;
              
              const comment = `
              ## ØªÙ‚Ø±ÙŠØ± ØªØºØ·ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ğŸ“Š
              
              | Ø§Ù„Ù†ÙˆØ¹ | Ø§Ù„ØªØºØ·ÙŠØ© | Ø§Ù„ØªØºÙŠÙŠØ± |
              |-------|---------|---------|
              | Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ | ${total.lines.pct}% | ${total.lines.change > 0 ? 'â†—ï¸' : 'â†˜ï¸'} ${total.lines.change}% |
              | Ø§Ù„Ø¯ÙˆØ§Ù„ | ${total.functions.pct}% | ${total.functions.change > 0 ? 'â†—ï¸' : 'â†˜ï¸'} ${total.functions.change}% |
              | Ø§Ù„ÙØ±ÙˆØ¹ | ${total.branches.pct}% | ${total.branches.change > 0 ? 'â†—ï¸' : 'â†˜ï¸'} ${total.branches.change}% |
              | Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª | ${total.statements.pct}% | ${total.statements.change > 0 ? 'â†—ï¸' : 'â†˜ï¸'} ${total.statements.change}% |
              
              [ğŸ“ˆ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/coverage-report/)
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  notify-team:
    name: Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ±ÙŠÙ‚
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, unit-tests, integration-tests, e2e-tests, build-and-deploy]
    if: always()
    
    steps:
      - name: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Slack
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#frontend-team'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          custom_payload: |
            {
              "text": "ğŸ¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Frontend",
              "attachments": [{
                "color": "${{ job.status == 'success' && 'good' || 'danger' }}",
                "fields": [
                  {
                    "title": "Ø§Ù„ÙˆØ¸ÙŠÙØ©",
                    "value": "${{ github.event.head_commit.committer.name }}",
                    "short": true
                  },
                  {
                    "title": "Ø§Ù„ÙØ±Ø¹",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Ø§Ù„Ø­Ø§Ù„Ø©",
                    "value": "${{ job.status }}",
                    "short": true
                  }
                ]
              }]
            }